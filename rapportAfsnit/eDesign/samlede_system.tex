\section{Det samlede system}\label{sec:samlet_system}
\textit{Dette afsnit omhandler test af det samlede system, hvis design og implementering består af indholdet fra de forrige blokke. Designet af det samlede system har til formål at opfylde de specifikke krav i \secref{krav_samlet_sys}.}

Det samlede system består en række blokke, som tidligere er blevet designet, implementeret og testet for, hvorvidt disse blokke opfylder deres krav. Det fremgår af testene, at de separate blokke overholder de opstillede krav. Det samlede system sammensættes af hver enkelt blok og implementeres, som det fremgår af \figref{fig:design_blokdiagram}.% Det følgende afsnit vil derfor indebære en test af funktionaliteten for det samlede system i forhold til kravene opstillet i \secref{krav_samlet_sys}. 

\subsection{Test}
Testen udføres med henhold til de opstillede krav og tilhørende tilladte afvigelser opstillet i \secref{krav_samlet_sys}. Kravene beskriver, at det samlede system skal:
\begin{itemize}
	\item Kunne detektere aktiviteterne gang, løb og cykling ved brug af gyroskop og accelerometer. Der accepteres ikke brug af andre sensorer.
	\item Kunne lave automatisk adskillelse af gang, løb og cykling ved hjælp af algoritmer. Der accepteres en afvigelse på 10\% i forhold til fejlvurdering af aktivitet og varighed.
	\item Kunne detektere puls ved brug af pulssensor og tilhørende algoritme samt derefter kategorisere intensiteten af en given aktivitet. Der accepteres en pulsafvigelse på 10\%.
	\item Videresende signaler til en ekstern enhed ved hjælp af BLE. Der accepteres ikke andre trådløse kommunikationsformer.
	\item Besidde batterilevetid for en hel dag svarende til 15 timer. Der accepteres ikke en batterilevetid på mindre end 15 timer.
	\item Repræsentere varigheden og pointfordelingen af en given aktivitet i GUI. Der accepteres ikke en anden form for visualisering. 
\end{itemize}
Kravet om registrering af puls vil ikke blive opfyldt, da pulssensoren ikke indgår i det samlede system, se \secref{sec_de_im_te_puls}. \\
Formålet med test af det samlede system er altså at undersøge, hvorledes disse krav samt tolerancer overholdes. Det samlede systems funktionalitet testes ved først at opsætte softwaren på ICen og GAP peripheral ved hjælp af PSoC programmer. Derefter skal ICen sammensættes med MCUen samt en spændingsforsyning til begge enheder og påsættes på en forsøgsperson. GAP central tilkobles en computer, hvorved denne MCU modtager signaler fra GAP peripheral og sender dette ind i computeren. GAP peripheral kommunikerer trådløst ved hjælp af BLE med GAP central, hvorved data fra GAP central illustreres i en GUI. Denne forsøgsopstilling fremgår af \figref{fig:samlede_system_opstilling}.

\textbf{FIGUR: BILLEDE AF SYSTEM PLACERET PÅ BENET.} \\
%\begin{figure}[H]
%	\centering
%	\includegraphics[scale=0.5]{figures/cDesign/samlede_system_opstilling.png}
%	\caption{På figuren ses opsætningen af det endelige system på en forsøgsperson.}
%	\label{fig:samlede_system_opstilling}
%\end{figure}

Ved test af det samlede system skal en forsøgsperson udføre tre aktiviteter: gang med 4,8 km/t, løb med 11,3 km/t og cykling med 20,9 km/t. Hver aktivitet skal udføres i 60 sekunder, og dataopsamlingen skal påbegyndes, når forsøgspersonen vurderer at have en homogen cyklus. Forinden tages en 60 sekunders måling, hvor forsøgspersonen står stille på løbebåndet. Det antages, at GUIen herved ikke vil optage nogen aktivitet. Fremgangsmåden for første test af systemet med gang ses herunder: 
\begin{itemize}
	\item GAP central og peripheral skal opdateres med korrekt algoritme på begge 4200M og EZ\_BLE mikroprocessorer.
	\item GAP peripheral med IC og en spændingsforsyning skal placeres proximalt for den laterale malleolus.
	\item GAP central kobles til en PC. 
	\item Forsøgspersonen skal stå oprejst med ret ryg, kigge ligeud og fødderne placeret parallelt på løbebåndet under 60 sekunders måling uden fysisk aktivitet.
	\item Herefter indstilles løbebåndet til en hastighed på 4,8 km/t. Forsøgspersonen går på løbebåndet indtil en homogen cyklus er opnået.  
	\item Et stopur startes samtidig med GUI, hvorved datastreaming fra GAP peripheral visualiseres på PCen.
	\item Dataopsamlingen skal foregå i 60 sekunder ifølge stopuret, hvorefter der trykkes på Q i MATLAB. Dette fryser figuren, således værdierne ved 60 sekunder kan aflæses.
	\item Målingen stoppes.
\end{itemize}
Denne fremgangsmåde gentages to gange, hvor anden test er for detektion af løb og tredje test er for detektion af cykling. Forsøgspersonen dog sidder på en motionscykel under detektion af cykling. Resultatet fra denne test fremkommer som en fordeling af aktiviteter på GUIen, der helst ikke skal opfange aktivitet under målingen med ingen fysisk aktivitet. \\
Resultatet fra de forskellige tests ses i \tabref{tab:samlet_sys_test1}
\begin{table}[H]
	\centering
	\begin{tabular}{ccccc}
		\hline
		\rowcolor[HTML]{C0C0C0} 
		Udført aktivitet & \begin{tabular}[c]{@{}c@{}} Detektion \\ af gang {[}Min{[} \end{tabular} & \begin{tabular}[c]{@{}c@{}} Detektion\\ af løb {[}Min{[}\end{tabular} & \begin{tabular}[c]{@{}c@{}} Detektion \\ af cykling {[}Min{[}\end{tabular} & \begin{tabular}[c]{@{}c@{}} Afvigelse {[}\%{[} \end{tabular} \\ \hline
		Gang & 0 & 100 & 0 & 100 \\ \hline
		Løb & 0 & 100 & 0 & 0 \\ \hline
		Cykling & 0 & 0 & 100 & 0 \\ \hline
	\end{tabular}%
	\caption{I tabellen ses resultaterne fra de tre tests af det samlede system.}%mhandlede revurdering af algoritmens tærskelværdier, samt vurdering af pulssensor.}
	\label{tab:samlet_sys_test1}
\end{table}\vspace{-.5cm}

Der ses i \tabref{tab:samlet_sys_test1}, at systemet ikke detekterer gang korrekt. Det antages at være i forbindelse med tærskelværdierne, der adskiller gang og løb. Data fra Shimmer skal multipliceres med 16 for at give samme output, som data fra ICen, hvilket fremgår i \secref{sec:algogangloeb}. Der findes dog ikke samme forhold efter databehandlingen, hvorfor tærskelværdierne ikke blot kan multipliceres med 16. Derfor fortages endnu test, hvor målingerne skal ske ved konstant hastighed for henholdsvis gang og løb for at undersøge maksimal peak værdier. Derudover skal GAP peripheral kun sende data fra accelerometret, hvilket visualiseres i Realterm ved hjælp af GAP central. Algoritmen på GAB peripheral reguleres altså således, at gyroskopets data ikke sendes via BLE og tidsenheden imellem maks peaks er i dette tilfælde relevant. Der ønskes udelukkende en værdi for detekteringen af maks peak. Fremgangsmåden for denne test forekommer således:
\begin{itemize}
		\item GAP central og peripheral skal opdateres med korrekt algoritme på begge 4200M og EZ\_BLE mikroprocessorer.
		\item GAP peripheral med IC og en spændingsforsyning skal placeres proximalt for den laterale malleolus.
		\item GAP central kobles til en PC. 
		\item En test af forbindelsen imellem GAP central og peripheral testes ved brug af Realterm på PCen.
		\item Løbebåndet indstilles til 4,8 km/t. Forsøgspersonen går på løbebåndet indtil en konstant hastighed er opnået.
		\item Realterm skal herefter visualisere data i 30 sekunder.
		\item Målingen stoppes
\end{itemize}
Samme test fortages, hvor løbebåndet indstilles til 11,3 km/t. Data fra realterm konverteres, således Matlab kan genkende datatypen, hvorved en gennemsnitsværdi beregnes. Resultatet af disse to tests ses i \tabref{tab:samlet_sys_regulering}
\begin{table}[H]
	\centering
	\begin{tabular}{cc}
		\hline
		\rowcolor[HTML]{C0C0C0} 
		Aktivitet & \begin{tabular}[c]{@{}c@{}} Gennemsnitsværdi \\ for maks peak \end{tabular} \\ \hline
			Gang & ? \\ \hline
			Løb & ? \\ \hline
		\end{tabular}%
		\caption{I tabellen ses resultatet fra reguleringstesten for accelerometerdata.}
		\label{tab:samlet_sys_regulering}
\end{table}\vspace{-.5cm}
Der ses i \tabref{tab:samlet_sys_regulering}, at maks peak værdierne for gang er langt højere, end værdierne var ved brug af Shimmer sensoren. Tærskelværdien for gang er 50, mens den for løb er 400. Disse skal reguleres, hvorefter det antages at algoritmen er tilpasset ICen. Ud fra værdierne fra \tabref{tab:samlet_sys_regulering} vælges de regulerede tærskelværdier til henholdsvis ? og ?. De nye tærskelværdier fremgår i \tabref{tab:samlet_sys_regulering2}.
\begin{table}[H]
	\centering
	\begin{tabular}{ccc}
		\hline
		\rowcolor[HTML]{C0C0C0} 
		Aktivitet & Gammel tærskelværdi & Reguleret tærskelværdi \\ \hline
		Ingen aktivitet &  x~$\textless$~50 & ? \\ \hline
		Gang & 50~$\textless$~x~$\textgreater$~400 & ? \\ \hline
		Løb & 400~$\textgreater$~x & ? \\ \hline
	\end{tabular}%
	\caption{I tabellen ses resultatet fra reguleringstesten for accelerometerdata.}
	\label{tab:samlet_sys_regulering2}
\end{table}\vspace{-.5cm}
Dette korrigeres inde i algoritmedesignet. Herefter fortages de tre seperate tests igen for det samlede system. Resultatet heraf ses i \tabref{tab:samlet_sys_test2}.
\begin{table}[H]
	\centering
	\begin{tabular}{ccccc}
		\hline
		\rowcolor[HTML]{C0C0C0} 
		Test nummer & \begin{tabular}[c]{@{}c@{}} Detektion \\ af gang {[}\%{[} \end{tabular} & \begin{tabular}[c]{@{}c@{}} Detektion\\ af løb {[}\%{[}\end{tabular} & \begin{tabular}[c]{@{}c@{}} Detektion \\ af cykling {[}\%{[}\end{tabular} & \begin{tabular}[c]{@{}c@{}} Afvigelse {[}\%{[} \end{tabular} \\ \hline
			1 & 100 & 0 & 0 & 0 \\ \hline
			2 & 0 & 100 & 0 & 0 \\ \hline
			3 & 0 & 0 & 100 & 0 \\ \hline
		\end{tabular}%
		\caption{I tabellen ses resultaterne fra de tre tests af den anden samlede test af systemet. Der ses, at detektionen af den specifikke aktivitet er mere præcis efter reguleringen af tærskelværdierne.}%mhandlede revurdering af algoritmens tærskelværdier, samt vurdering af pulssensor.}
		\label{tab:samlet_sys_test2}
\end{table}\vspace{-.5cm}
Det ses i \tabref{tab:samlet_sys_test2}, at systemet overholder kravet om en maksimal afvigelse på 10\% i forhold til fejlvurdering af aktivitet. \textbf{kog noget mere på det her, når vi har testet}.

Systemet testes ligeledes for batteriets levetid. %, med henblik på at af,- eller bekræfte kravet vedrørende at kunne være batteridrevet igennem en hel dag. 
Systemets initialeres til at starte samtidig med et stopur. Det samlede systems spændingsforsyning tilkobles et multimeter for at kunne måle dets spænding inden forsøget. Systemet skal køre uafbrudt i en time, hvorefter spændingsforsyningens igen tilkoples et multimeter og måles igen. 
\begin{table}[H]
	\centering
	\begin{tabular}{cc}
		\hline
		\rowcolor[HTML]{C0C0C0} 
		Spændingsniveau før forsøg {[}V{]} & Spændingsniveau efter forsøg {[}V{]} \\ \hline
		3,14 & ????2,78???? \\ \hline
	\end{tabular}
	\caption{I tabellen ses testresultaterne vedrørende det samlede systems spændingsforbrug.}
	\label{tab:test_spaending}
\end{table} \vspace{-.5cm}
Ud fra ovenstående testresultater beregnes der, at det samledes system forbruger 0,36 V per time. På baggrund i design af sensoren LSM9DS1 vides der, at den minimale tilførte spænding for funktionalitet af sensoren er 2,40 V. Dette resulterer systemet kan forbruge 0,74 V fra start, hvorefter systemet ikke forventes at fungere mere. 

\begin{equation}
Varighed~vedr\text{ø}rende~line\text{æ}r~operation = \frac{0,74~V}{0,36~V~per~time} = 2,05~timer
\end{equation}   
Det samlede system vil efter 2,05 timer have opbrugt tilpas spænding, således sensoren ikke længere er funktionel. % have opbrugt det spændingsarbejdsområde, hvoraf sensoreren opererer lineært. 
Test af systemets levetid per batteri afkræfter dermed kravet heraf.

Det samlede systems krav vedrørende et komfortabelt produkt for brugeren, samt bestå af et motiverende element for børn i aldersgruppen 9-12 år, blev ikke implementeret. Dette blev ikke implementeret, da systemet er en prototype, hvoraf fokus er på dets funktionalitet. 

%%%%%%%%%%%%%%%%%%%%%%%%%%%% Nye diskutterede ting under forsøget
% Vi tager 1 minuts måling for hver person, hvor de ikke laver nogen aktivitet. Her påvises det, at der ikke detekteres nogen aktivitet. 